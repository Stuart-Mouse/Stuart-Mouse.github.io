<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="chrome=1, IE=edge">
        <title>Autumn Collage</title>
        <style>
            @font-face {
                font-family: "EBGaramond";
                src: url("./media/EBGaramond-Bold.ttf");
            }
            
            .fullwindow {
                position: absolute;
                top: 0px;
                left: 0px;
                margin: 0px;
                border: 0;
                width: 100%;
                height: 100%;
                overflow: hidden;
                display: block;
            }
            
            .share_button {
                font-family: "EBGaramond";
            
                position: fixed;
                top: 5%;
                left: 50%;
                margin: 0px;
                padding: 1vh;
                border: 0;
                width: auto;
                height: auto;
                font-size: 3vh;
                overflow: hidden;
                z-index: -1;
                display: block;
                
                background-color: rgba(40, 40, 40, 0);
                color: white;
                text-shadow: 2px 2px 5px black;
                
                transform: translate(-50%, -50%);
                
                opacity: 0;
                transition: height 100ms 100ms, opacity 400ms 0ms;
                
                border-radius: 1vh;
            }
            
            .share_button:hover {
                color: orange;
                text-shadow: 2px 2px 10px black;
                transition: color 500ms, text-shadow 500ms;
            }
            
            .spotify_preview {
                position: fixed;
                top: 8%;
                left: 50%;
                margin: 0px;
                padding: 0px;
                border: 0;
                width: 50%;
                min-width: 500px;
                height: 15%;
                overflow: hidden;
                z-index: -1;
                display: block;
                
                transform: translate(-50%, -50%);
                
                opacity: 0;
                transition: height 100ms 100ms, opacity 400ms 0ms;
                
                border-radius:12px
            }
            .visible {
                opacity: 1;
                transition: height 100ms 100ms, opacity 400ms 0ms;
            }
        </style>
        <script>
            function show_spotify_preview(spotify_id, youtube_id) {
                if (spotify_id) {
                    document.getElementById("spotify_preview").innerHTML = '<iframe style="" src="https://open.spotify.com/embed/track/' + spotify_id + '?utm_source=generator&theme=0" width="100%" height="100%" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>';
                    document.getElementById("spotify_preview").classList.add('visible');
                    document.getElementById("spotify_preview").style.zIndex = "5";
                } else {
                    document.getElementById("youtube").onclick = function () { window.open('https://youtu.be/' + youtube_id, '_blank').focus(); };
                    document.getElementById("youtube").classList.add('visible');
                    document.getElementById("youtube").style.zIndex = "5";
                }
                
                document.getElementById("share").classList.remove('visible');
                document.getElementById("share").style.zIndex = "4";
            }
            
            function hide_spotify_preview() {
                document.getElementById("spotify_preview").innerHTML = '';
                document.getElementById("spotify_preview").classList.remove('visible');
                document.getElementById("spotify_preview").style.zIndex = "4";
                
                document.getElementById("youtube").classList.remove('visible');
                document.getElementById("youtube").style.zIndex = "4";
                
                document.getElementById("share").classList.add('visible');
                document.getElementById("share").style.zIndex = "5";
            }
            
            function update_aspect(aspect) {
                if (aspect < 0.8) {
                    document.getElementById("spotify_preview").style.width = '90%';
                } else {
                    document.getElementById("spotify_preview").style.width = '50%';
                }
            }
            
            function begin_results_page() {
                document.getElementById('share').classList.add('visible');
                document.getElementById("share").style.zIndex = "5";
                document.getElementById("spotify_preview").style.zIndex = "4";
            }
        </script>
    </head>
    <body style="background-color: #FFFFFF;">
        <canvas class = "fullwindow" id="canvas" oncontextmenu="event.preventDefault()"></canvas>
        <button id="share" type="button" class="share_button">Share your vibe!</button>
        <button id="youtube" type="button" class="share_button">Listen on YouTube!</button>
        <div id="spotify_preview" class="spotify_preview"></div>
        <script type="text/javascript">
            var Module = {};
            Module.canvas = document.getElementById('canvas');
        </script>
        <script>
            document.getElementById("share").addEventListener("click", async () => {
                const image_data = Module.get_image_data();
                
                console.log(image_data.byteLength);
                console.log(image_data.length);
                console.log(image_data.BYTES_PER_ELEMENT);
                
                const image_data_blob = new Blob([image_data], { type: "image/bmp" });
                
                const urlobj = URL.createObjectURL(image_data_blob);
                
                const blob = await fetch(urlobj).then(r=>r.blob());
                
                const files = [
                    new File([blob], 'file.bmp', {
                        type: blob.type,
                })];
                
                console.log(files[0].size);
                
                if (navigator.canShare({ files })) {
                    try {
                        await navigator.share({
                            files,
                            title: "Images",
                            text: "Beautiful images",
                        });
                        console.log("Shared!");
                    } catch (error) {
                        console.log(`Error: ${error.message}`);
                    }
                } else {
                    console.log(`Your system doesn't support sharing these files.`);
                }
            });
        </script>
        <script>
            history.pushState(null, null, window.top.location.pathname + window.top.location.search);
            window.addEventListener('popstate', (e) => {
                e.preventDefault();
                Module.back_button_pressed()
                history.pushState(null, null, window.top.location.pathname + window.top.location.search);
            });
        </script>

        <script async type="text/javascript" src="./main.js"></script>
    </body>
</html>

