<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="chrome=1, IE=edge">
        <title>Autumn Collage</title>
        <style>
            .fullwindow {
                position: absolute;
                top: 0px;
                left: 0px;
                margin: 0px;
                border: 0;
                width: 100%;
                height: 100%;
                overflow: hidden;
                display: block;
            }
            
            .share_button {
                position: fixed;
                top: 0px;
                right: 0px;
                margin: 10px;
                padding: 10px;
                border: 0;
                width: 25%;
                min-width: 300px;
                height: 10%;
                font-size: 2.5vh;
                overflow: hidden;
                z-index: 5;
                display: block;
                
                opacity: 0;
                transition: height 100ms 100ms, opacity 400ms 0ms;
                
                border-radius: 1vh;
            }
            
            .spotify_preview {
                position: fixed;
                top: 0px;
                right: 0px;
                margin: 10px;
                padding: 0px;
                border: 0;
                width: 25%;
                min-width: 300px;
                height: 10%;
                font-size: 2.5vh;
                overflow: hidden;
                z-index: 5;
                display: block;
                
                opacity: 0;
                transition: height 100ms 100ms, opacity 400ms 0ms;
                
                border-radius:12px
            }
            .visible {
                opacity: 0.85;
                transition: height 100ms 100ms, opacity 400ms 0ms;
            }
            
        </style>
        <script>
            function show_spotify_preview(song_id) {
                document.getElementById("spotify_preview").innerHTML = '<iframe style="" src="https://open.spotify.com/embed/track/' + song_id + '?utm_source=generator&theme=0" width="100%" height="100%" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>';
                document.getElementById("spotify_preview").classList.add('visible');
                document.getElementById("share").classList.remove('visible');
            }
            
            function hide_spotify_preview() {
                document.getElementById("spotify_preview").innerHTML = '';
                document.getElementById("spotify_preview").classList.remove('visible');
                document.getElementById("share").classList.add('visible');
            }
        </script>
    </head>
    <body style="background-color: #FFFFFF;">
        <canvas class = "fullwindow" id="canvas" oncontextmenu="event.preventDefault()"></canvas>
        <button id="share" type="button" class="share_button">Share your vibe!</button>
        <div id="spotify_preview" class="spotify_preview"></div>
        <script type="text/javascript">
            var Module = {};
            Module.canvas = document.getElementById('canvas');
        </script>
        <script>
            document.getElementById("share").addEventListener("click", async () => {
              const image_data = Module.get_image_data();
              
              console.log(image_data.byteLength);
              console.log(image_data.length);
              console.log(image_data.BYTES_PER_ELEMENT);
              
              const image_data_blob = new Blob([image_data], { type: "image/bmp" });
              
              const urlobj = URL.createObjectURL(image_data_blob);
              
              const blob = await fetch(urlobj).then(r=>r.blob());
              
              const files = [
                new File([blob], 'file.bmp', {
                  type: blob.type,
              })];
              
              console.log(files[0].size);
              
              if (navigator.canShare({ files })) {
                try {
                  await navigator.share({
                    files,
                    title: "Images",
                    text: "Beautiful images",
                  });
                  console.log("Shared!");
                } catch (error) {
                  console.log(`Error: ${error.message}`);
                }
              } else {
                console.log(`Your system doesn't support sharing these files.`);
              }
            });
        </script>
        <script async type="text/javascript" src="./main.js"></script>
    </body>
</html>

